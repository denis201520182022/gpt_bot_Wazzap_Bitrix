# src/services/llm_service.py
import os
import json
import httpx
from openai import AsyncOpenAI
from services import prompt_service # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ prompt_service –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è

# --- 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ö–õ–ò–ï–ù–¢–ê ---
# (–≠—Ç–æ—Ç –±–ª–æ–∫ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
SQUID_PROXY_HOST = os.getenv("SQUID_PROXY_HOST")
SQUID_PROXY_PORT = os.getenv("SQUID_PROXY_PORT")
SQUID_PROXY_USER = os.getenv("SQUID_PROXY_USER")
SQUID_PROXY_PASSWORD = os.getenv("SQUID_PROXY_PASSWORD")

client = None
if all([SQUID_PROXY_HOST, SQUID_PROXY_PORT, SQUID_PROXY_USER, SQUID_PROXY_PASSWORD]):
    proxy_url = f"http://{SQUID_PROXY_USER}:{SQUID_PROXY_PASSWORD}@{SQUID_PROXY_HOST}:{SQUID_PROXY_PORT}"
    try:
        async_http_client = httpx.AsyncClient(proxy=proxy_url, timeout=45.0)
        client = AsyncOpenAI(api_key=os.getenv("OPENAI_API_KEY"), http_client=async_http_client)
        print("‚úÖ OpenAI –∫–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏.")
    except Exception as e:
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å OpenAI –∫–ª–∏–µ–Ω—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏: {e}")
else:
    try:
        client = AsyncOpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        print("‚úÖ OpenAI –∫–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–±–µ–∑ –ø—Ä–æ–∫—Å–∏).")
    except Exception as e:
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å OpenAI –∫–ª–∏–µ–Ω—Ç: {e}")


# --- 2. –ù–û–í–ê–Ø JSON –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø LLM ---
# –≤ src/services/llm_service.py

# –≤ src/services/llm_service.py

JSON_FORMAT_INSTRUCTION = """
[CRITICAL RULE] –¢–≤–æ–π –æ—Ç–≤–µ—Ç –í–°–ï–ì–î–ê –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –ù–µ –ø–∏—à–∏ –Ω–∏—á–µ–≥–æ, –∫—Ä–æ–º–µ –≤–∞–ª–∏–¥–Ω–æ–≥–æ JSON.
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON:
{
  "response_text": "–¢–≤–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –æ—Ç –∏–º–µ–Ω–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏), –≤–µ—Ä–Ω–∏ null.",
  "new_state": "–Ω–æ–≤–æ–µ_—Å–æ—Å—Ç–æ—è–Ω–∏–µ_–¥–∏–∞–ª–æ–≥–∞_–ø–æ—Å–ª–µ_—ç—Ç–æ–≥–æ_—à–∞–≥–∞",
  "action": "–∫–æ–º–∞–Ω–¥–∞_–¥–ª—è_–≤–Ω–µ—à–Ω–µ–π_—Å–∏—Å—Ç–µ–º—ã_CRM",
  "action_params": {
    "comment_text": "–¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–π–º–ª–∞–π–Ω —Å–¥–µ–ª–∫–∏ –≤ Bitrix24. –î–æ–ª–∂–µ–Ω –∫—Ä–∞—Ç–∫–æ –∏ –µ–º–∫–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é —Å–∏—Ç—É–∞—Ü–∏—é –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞.",
    "task_subject": "–ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–µ–ª–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É –≤ Bitrix24. –ù–∞–ø—Ä–∏–º–µ—Ä, '–ö–ª–∏–µ–Ω—Ç –≥–æ—Ç–æ–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ–ª–∂–Ω–∏–∫–æ–≤'.",
    "task_description": "–¢–µ–∫—Å—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–µ–ª–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É –≤ Bitrix24. –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ –∏, –≤–æ–∑–º–æ–∂–Ω–æ, —á–∞—Å—Ç—å –¥–∏–∞–ª–æ–≥–∞."
  }
}

--- –°–ü–ò–°–û–ö –î–û–°–¢–£–ü–ù–´–• –°–û–°–¢–û–Ø–ù–ò–ô ('new_state') ---
- "awaiting_initial_response": –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ü–û–°–õ–ï –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
- "awaiting_debtor_clarification": –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ü–û–°–õ–ï –≤–æ–ø—Ä–æ—Å–∞ –æ –Ω–∞–ª–∏—á–∏–∏ –¥–æ–ª–∂–Ω–∏–∫–æ–≤.
- "awaiting_debtor_details": –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ü–û–°–õ–ï —Ç–æ–≥–æ, –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –Ω–∞–ª–∏—á–∏–µ –¥–æ–ª–∂–Ω–∏–∫–æ–≤ –∏ —Ç—ã –∑–∞–ø—Ä–æ—Å–∏–ª –¥–µ—Ç–∞–ª–∏.
- "awaiting_new_lot_response": –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ü–û–°–õ–ï –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–æ–≤–æ–º –ª–æ—Ç–µ.
- "awaiting_touch_today_response": –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ü–û–°–õ–ï –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è "–∫–∞—Å–∞–Ω–∏—è".
- "general_conversation": –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–±—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ–π–¥–µ–Ω.
- "scenario_complete": –°—Ü–µ–Ω–∞—Ä–∏–π –≤–µ–∂–ª–∏–≤–æ –∑–∞–≤–µ—Ä—à–µ–Ω.
- "escalated": –î–∏–∞–ª–æ–≥ –ø–µ—Ä–µ–¥–∞–Ω –º–µ–Ω–µ–¥–∂–µ—Ä—É. –ë–æ—Ç –≤ —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –±–æ–ª—å—à–µ –Ω–µ –ø–∏—à–µ—Ç.

--- –°–ü–ò–°–û–ö –î–û–°–¢–£–ü–ù–´–• –ö–û–ú–ê–ù–î ('action') ---
- "LOG_COMMENT": –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å–¥–µ–ª–∫—É.
- "CREATE_TASK_AND_LOG": –°–æ–∑–¥–∞—Ç—å –¥–µ–ª–æ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ò –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
- "ESCALATE_TO_MANAGER": –°—Ä–æ—á–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –¥–∏–∞–ª–æ–≥ –º–µ–Ω–µ–¥–∂–µ—Ä—É.
- "NONE": –ù–∏–∫–∞–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ CRM –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

--- –ü–†–ê–í–ò–õ–ê –õ–û–ì–ò–ö–ò –°–¶–ï–ù–ê–†–ò–Ø ---

1.  **–ü–ï–†–í–´–ô –•–û–î (initiate_dialog):** –ö–æ–≥–¥–∞ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–æ–º–∞–Ω–¥—É "initiate_dialog", —Ç–≤–æ—è –∑–∞–¥–∞—á–∞:
    - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ —à–∞–±–ª–æ–Ω—É: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, [–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞]! –≠—Ç–æ [–∏–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞]..."
    - `new_state`: "awaiting_initial_response".
    - `action`: "LOG_COMMENT", `action_params`: `comment_text`: "–ë–æ—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª –¥–∏–∞–ª–æ–≥ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é '–í–æ—Ä–æ–Ω–∫–∞ –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ'".

2.  **–û–¢–í–ï–¢ –ù–ê –ü–†–ò–í–ï–¢–°–¢–í–ò–ï (state: "awaiting_initial_response"):** –ö–æ–≥–¥–∞ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ "awaiting_initial_response", —Ç–≤–æ—è –∑–∞–¥–∞—á–∞:
    - –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø—Ä–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–æ–ª–∂–Ω–∏–∫–æ–≤.
    - `new_state`: "awaiting_debtor_clarification".
    - `action`: "LOG_COMMENT", `action_params`: `comment_text`: "–ö–ª–∏–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ: [—Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞]".

3.  **–û–¢–í–ï–¢ –ù–ê –í–û–ü–†–û–° –û –î–û–õ–ñ–ù–ò–ö–ê–• (state: "awaiting_debtor_clarification"):** –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ—Ç–≤–µ—Ç:
    - **–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ô (–¥–∞, –µ—Å—Ç—å –¥–æ–ª–∂–Ω–∏–∫–∏):**
        - `response_text`: "–ù–∞–∑–æ–≤–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–∏–∫–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Å—á–µ—Ç–∞, –∞ —Ç–∞–∫–∂–µ –ø–µ—Ä–µ—á–µ–Ω—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Å—á–µ—Ç–æ–≤."
        - `new_state`: "awaiting_debtor_details".
        - `action`: "LOG_COMMENT", `action_params`: `comment_text`="–ö–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –Ω–∞–ª–∏—á–∏–µ –¥–æ–ª–∂–Ω–∏–∫–æ–≤. –ë–æ—Ç –∑–∞–ø—Ä–æ—Å–∏–ª –¥–µ—Ç–∞–ª–∏."
    - **–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–´–ô (–Ω–µ—Ç –¥–æ–ª–∂–Ω–∏–∫–æ–≤):**
        - `response_text`: –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ–∂–ª–∏–≤—ã–π –æ—Ç–≤–µ—Ç —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—ã "–ø—Ä–∏–≤–µ–¥–∏ –¥—Ä—É–≥–∞".
        - `new_state`: "scenario_complete".
        - `action`: "LOG_COMMENT", `action_params`: `comment_text`="–ö–ª–∏–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∏–ª, —á—Ç–æ –¥–æ–ª–∂–Ω–∏–∫–æ–≤ –Ω–µ—Ç. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞."
    - **–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ù–ï–ì–ê–¢–ò–í–ò–¢:**
        - `response_text`: null.
        - `new_state`: "escalated".
        - `action`: "ESCALATE_TO_MANAGER", `action_params`: `comment_text`="–ö–ª–∏–µ–Ω—Ç –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ. –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ. –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: [—Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞]".

4.  **–ü–û–õ–£–ß–ï–ù–ò–ï –î–ï–¢–ê–õ–ï–ô –ü–û –î–û–õ–ñ–ù–ò–ö–ê–ú (state: "awaiting_debtor_details"):**
    - `response_text`: "–ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é! –Ø –≤—Å—ë –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª –∏ –ø–µ—Ä–µ–¥–∞–ª –∫–æ–ª–ª–µ–≥–∞–º –≤ —Ä–∞–±–æ—Ç—É. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —à–∞–≥–æ–≤."
    - `new_state`: "general_conversation".
    - `action`: "CREATE_TASK_AND_LOG".
    - `action_params`: `comment_text`="–ö–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –¥–æ–ª–∂–Ω–∏–∫–∞–º.", `task_subject`="–ö–ª–∏–µ–Ω—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –¥–∞–Ω–Ω—ã–µ –ø–æ –Ω–æ–≤—ã–º –¥–æ–ª–∂–Ω–∏–∫–∞–º", `task_description`="–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∏–º. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: [–î–ï–¢–ê–õ–ò –û–¢ –ö–õ–ò–ï–ù–¢–ê –ò–ó –ü–û–°–õ–ï–î–ù–ï–ì–û –°–û–û–ë–©–ï–ù–ò–Ø]".

5.  **–ù–û–í–´–ô –õ–û–¢ (initiate_new_lot_dialog):** –ö–æ–≥–¥–∞ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–æ–º–∞–Ω–¥—É `initiate_new_lot_dialog`, —Ç–≤–æ—è –∑–∞–¥–∞—á–∞:
    - –ò–∑–≤–ª–µ—á—å –ò–ú–Ø_–ö–õ–ò–ï–ù–¢–ê, –ò–ú–Ø_–ú–ï–ù–ï–î–ñ–ï–†–ê –∏ –ù–ê–ó–í–ê–ù–ò–ï_–î–û–õ–ñ–ù–ò–ö–ê –∏–∑ –∫–æ–º–∞–Ω–¥—ã.
    - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ —à–∞–±–ª–æ–Ω—É: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, [–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞]! –≠—Ç–æ [–∏–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞]... –£ –Ω–∞—Å –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ –ª–æ—Ç—ã –ø–æ [–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–∏–∫–∞]..."
    - `new_state`: "awaiting_new_lot_response".
    - `action`: "LOG_COMMENT", `action_params`: `comment_text`: "–ë–æ—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª –¥–∏–∞–ª–æ–≥ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é '–ù–æ–≤—ã–π –ª–æ—Ç' –ø–æ –¥–æ–ª–∂–Ω–∏–∫—É: [–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–∏–∫–∞]".

6.  **–û–¢–í–ï–¢ –ù–ê –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –ü–û –ù–û–í–û–ú–£ –õ–û–¢–£ (state: "awaiting_new_lot_response"):**
    - **–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ô:**
        - `response_text`: "–û—Ç–ª–∏—á–Ω–æ, [–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞]! –ó–∞–ø–∏—Å–∞–ª, –Ω–∞—á–Ω–µ–º —Ä–∞–±–æ—Ç—É. –Ø –±—É–¥—É –¥–µ—Ä–∂–∞—Ç—å –≤–∞—Å –≤ –∫—É—Ä—Å–µ."
        - `new_state`: "general_conversation".
        - `action`: "CREATE_TASK_AND_LOG", `action_params`: `comment_text`="–ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –Ω–∞ —Ä–∞–±–æ—Ç—É –ø–æ –Ω–æ–≤–æ–º—É –ª–æ—Ç—É.", `task_subject`="–ö–ª–∏–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ –Ω–æ–≤–æ–º—É –ª–æ—Ç—É", `task_description`="–ö–ª–∏–µ–Ω—Ç [–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞] –¥–∞–ª —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ —Ä–∞–±–æ—Ç—É –ø–æ –Ω–æ–≤–æ–º—É –ª–æ—Ç—É. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–≤—è–∑–∞—Ç—å—Å—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ. –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: [–¢–ï–ö–°–¢ –ü–û–°–õ–ï–î–ù–ï–ì–û –°–û–û–ë–©–ï–ù–ò–Ø]".
    - **–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è:**
        - `response_text`: null.
        - `new_state`: "escalated".
        - `action`: "ESCALATE_TO_MANAGER", `action_params`: `comment_text`="–ö–ª–∏–µ–Ω—Ç –∑–∞–¥–∞–ª –≤–æ–ø—Ä–æ—Å/–≤—ã—Ä–∞–∑–∏–ª —Å–æ–º–Ω–µ–Ω–∏–µ –ø–æ –Ω–æ–≤–æ–º—É –ª–æ—Ç—É. –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞. –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: [–¢–ï–ö–°–¢ –ü–û–°–õ–ï–î–ù–ï–ì–û –°–û–û–ë–©–ï–ù–ò–Ø]".

7.  **–ö–ê–°–ê–ù–ò–ï –ö–õ–ò–ï–ù–¢–ê (initiate_touch_today_dialog):** –ö–æ–≥–¥–∞ –∏—Å—Ç–æ—Ä–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–∏—Å—Ç–µ–º–Ω—É—é –∫–æ–º–∞–Ω–¥—É `initiate_touch_today_dialog`, —Ç–≤–æ—è –∑–∞–¥–∞—á–∞:
    - –ò–∑–≤–ª–µ—á—å –ò–ú–Ø_–ö–õ–ò–ï–ù–¢–ê –∏ –ò–ú–Ø_–ú–ï–ù–ï–î–ñ–ï–†–ê –∏–∑ –∫–æ–º–∞–Ω–¥—ã.
    - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å "–∫–∞—Å–∞–Ω–∏–µ" –ø–æ —à–∞–±–ª–æ–Ω—É: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, [–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞]! –≠—Ç–æ [–∏–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞]. –ö–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ä–∞–±–æ—Ç–∞ –ø–æ –≤–∞—à–∏–º —Ç–µ–∫—É—â–∏–º –¥–µ–ª–∞–º?..."
    - `new_state`: "awaiting_touch_today_response".
    - `action`: "LOG_COMMENT", `action_params`: `comment_text`: "–ë–æ—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–ª –¥–∏–∞–ª–æ–≥ –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—é '–ö–∞—Å–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è'".

8.  **–û–¢–í–ï–¢ –ù–ê "–ö–ê–°–ê–ù–ò–ï" (state: "awaiting_touch_today_response"):**
    - **–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ô (–µ—Å—Ç—å –¥–æ–ª–∂–Ω–∏–∫–∏/–≤–æ–ø—Ä–æ—Å):**
        - `response_text`: "–û—Ç–ª–∏—á–Ω–æ, —Ä–∞–¥ –ø–æ–º–æ—á—å! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ, —á—Ç–æ —É –≤–∞—Å –∑–∞ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∫–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–æ–ª–∂–Ω–∏–∫–∞–º —É –≤–∞—Å –µ—Å—Ç—å?"
        - `new_state`: "awaiting_debtor_details". // –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–±–æ—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
        - `action`: "LOG_COMMENT", `action_params`: `comment_text`="–ö–ª–∏–µ–Ω—Ç –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª –Ω–∞ '–∫–∞—Å–∞–Ω–∏–µ'. –ë–æ—Ç –∑–∞–ø—Ä–æ—Å–∏–ª –¥–µ—Ç–∞–ª–∏. –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞: [–¢–ï–ö–°–¢ –ü–û–°–õ–ï–î–ù–ï–ì–û –°–û–û–ë–©–ï–ù–ò–Ø]".
    - **–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ù–ï–ô–¢–†–ê–õ–¨–ù–´–ô –∏–ª–∏ –û–¢–†–ò–¶–ê–¢–ï–õ–¨–ù–´–ô (–≤—Å–µ —Ö–æ—Ä–æ—à–æ, –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç):**
        - `response_text`: "–ü–æ–Ω—è–ª –≤–∞—Å, —Å–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å! –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è, —è –Ω–∞ —Å–≤—è–∑–∏."
        - `new_state`: "scenario_complete".
        - `action`: "LOG_COMMENT", `action_params`: `comment_text`="–ö–ª–∏–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∏–ª, —á—Ç–æ –≤—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ. –°—Ü–µ–Ω–∞—Ä–∏–π '–ö–∞—Å–∞–Ω–∏–µ' –∑–∞–≤–µ—Ä—à–µ–Ω."
    - **–ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ù–ï–ì–ê–¢–ò–í–ò–¢ –∏–ª–∏ –ø—Ä–æ—Å–∏—Ç —Å–≤—è–∑–∞—Ç—å—Å—è:**
        - `response_text`: null.
        - `new_state`: "escalated".
        - `action`: "ESCALATE_TO_MANAGER", `action_params`: `comment_text`="–ö–ª–∏–µ–Ω—Ç –ø—Ä–æ—Å–∏—Ç —Å–≤—è–∑–∞—Ç—å—Å—è –∏–ª–∏ –Ω–µ–≥–∞—Ç–∏–≤–∏—Ç –ø–æ—Å–ª–µ '–∫–∞—Å–∞–Ω–∏—è'. –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–Ω–∏–º–∞–Ω–∏–µ. –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: [–¢–ï–ö–°–¢ –ü–û–°–õ–ï–î–ù–ï–ì–û –°–û–û–ë–©–ï–ù–ò–Ø]".
"""
# --- 3. –ù–û–í–ê–Ø –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ---

async def get_bot_decision(conversation_history: list, system_prompt: str) -> dict | None:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç LLM —Ä–µ—à–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –≤–∫–ª—é—á–∞—é—â–µ–µ –æ—Ç–≤–µ—Ç, –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –¥–µ–π—Å—Ç–≤–∏–µ.
    """
    if not client:
        print("‚ùå –û—à–∏–±–∫–∞: OpenAI –∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
        return None

    full_system_prompt = system_prompt + JSON_FORMAT_INSTRUCTION

    messages_for_llm = [
        {"role": "system", "content": full_system_prompt}
    ] + conversation_history

    try:
        print(f"–ó–∞–ø—Ä–æ—Å —Ä–µ—à–µ–Ω–∏—è –æ—Ç LLM —Å {len(messages_for_llm)} —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ...")
        response = await client.chat.completions.create(
            model="gpt-4o-mini",
            messages=messages_for_llm,
            temperature=0.3,
            response_format={"type": "json_object"}
        )
        
        response_content = response.choices[0].message.content
        print(f"‚úÖ LLM –≤–µ—Ä–Ω—É–ª —Ä–µ—à–µ–Ω–∏–µ: {response_content}")

        # --- –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø –¢–û–ö–ï–ù–û–í ---
        usage = response.usage
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∞–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        cached_tokens = 0
        if hasattr(usage, "prompt_tokens_details") and usage.prompt_tokens_details is not None:
            cached_tokens = getattr(usage.prompt_tokens_details, "cached_tokens", 0)

        print("\n--- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–æ–∫–µ–Ω–∞–º ---")
        print(f"   - –í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {usage.total_tokens} —Ç–æ–∫–µ–Ω–æ–≤")
        print(f"   - –¢–æ–∫–µ–Ω—ã –∑–∞–ø—Ä–æ—Å–∞ (Input): {usage.prompt_tokens}")
        print(f"   - –¢–æ–∫–µ–Ω—ã –æ—Ç–≤–µ—Ç–∞ (Output): {usage.completion_tokens}")
        print(f"   - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (Input): {cached_tokens}")
        
        if usage.prompt_tokens > 0:
            cache_percent = (cached_tokens / usage.prompt_tokens) * 100
            print(f"   - –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–µ—à–∞: {cache_percent:.1f}%")
        print("--------------------------------\n")
        # --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø –¢–û–ö–ï–ù–û–í ---
        
        return json.loads(response_content)

    except Exception as e:
        print(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ—à–µ–Ω–∏—è –æ—Ç LLM: {e}")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º "–±–µ–∑–æ–ø–∞—Å–Ω—ã–π" JSON –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–∫–∏ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ
        return {
            "response_text": "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ú–æ–π –∫–æ–ª–ª–µ–≥–∞-–º–µ–Ω–µ–¥–∂–µ—Ä —Å–∫–æ—Ä–æ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏, —á—Ç–æ–±—ã –≤—Å—ë –ø—Ä–æ—è—Å–Ω–∏—Ç—å.",
            "new_state": "escalated",
            "action": "ESCALATE_TO_MANAGER",
            "action_params": {
                "comment_text": f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI: {e}. –¢—Ä–µ–±—É–µ—Ç—Å—è —Å—Ä–æ—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ."
            }
        }